name: Code Style Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

env:
  # Master branch (main or master)
  master_branch: master

permissions:
  contents: read
  pull-requests: write

jobs:
  astyle-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install AStyle
        run: |
          sudo apt-get update && sudo apt-get install -y lbzip2 build-essential cmake pkg-config libsdl2-dev || true
          sudo apt-get install -f -y
          wget https://sourceforge.net/projects/astyle/files/astyle/astyle%203.6/astyle-3.6.13.tar.bz2/download -O astyle.tar.bz2
          tar -xf astyle.tar.bz2
          cd astyle-3.6.13/
          mkdir -p build
          cd build
          cmake ../
          make
          sudo make install

      - name: Check code style
        run: |
          astyle --version
          
          # Find all C/C++ files
          FILES=$(find src include -type f \( -name "*.cpp" -o -name "*.h" \))
          
          if [ -z "$FILES" ]; then
            echo "No C/C++ files found to check"
            exit 0
          fi
          
          # Run astyle and check if any files would be formatted
          echo "$FILES" | xargs astyle --options=.astyle.cfg
          
          # Check if any files were modified
          if ! git diff --quiet; then
            echo "??  Code style issues found. The following files need formatting:"
            git diff --name-only
            echo ""
            echo "To fix formatting, run:"
            echo "  find src include -type f \( -name '*.cpp' -o -name '*.h' \) | xargs astyle --options=.astyle.cfg"
            git checkout .
            exit 1
          else
            echo "? All files are properly formatted!"
          fi